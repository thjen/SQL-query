CREATE DATABASE QUANLYDETAI

GO
USE QUANLYDETAI

-- TAO BANG
GO
CREATE TABLE THAMGIADT(
	MAGV CHAR(3),
	MADT CHAR(3),
	STT INT,
	PHUCAP FLOAT,
	KETQUA NVARCHAR(10),
	CONSTRAINT PK_THAMGIADT
	PRIMARY KEY(MAGV, MADT, STT),
)

GO 
CREATE TABLE KHOA(
	MAKHOA CHAR(3),
	TENKHOA NVARCHAR(50),
	NAMTL INT,
	PHONG CHAR(3),
	DIENTHOAI CHAR (11),
	TRUONGKHOA CHAR(3),
	NGAYNHANCHUC DATE,
	CONSTRAINT PK_KHOA
	PRIMARY KEY(MAKHOA)
)

GO
CREATE TABLE GIAOVIEN(
	MAGV CHAR(3),
	HOTEN NVARCHAR(50),
	LUONG FLOAT,
	PHAI NVARCHAR(5),
	NGAYSINH DATE,
	DIACHI NVARCHAR(100),
	GVQLCM CHAR(5),
	MABM NVARCHAR(5),
	CONSTRAINT PK_GIAOVIEN
	PRIMARY KEY(MAGV)
)

GO
CREATE TABLE BOMON(
	MABM NVARCHAR(5),
	TENBM NVARCHAR(50),
	PHONG CHAR(5),
	DIENTHOAI CHAR(11),
	TRUONGBM CHAR(3),
	MAKHOA CHAR(3),
	NGAYNHANCHUC DATE,
	CONSTRAINT PK_BOMON
	PRIMARY KEY(MABM),
)

GO
CREATE TABLE CONGVIEC(
	MADT CHAR (3),
	SOTT INT,
	TENCV NVARCHAR(50),
	NGAYBD DATE,
	NGAYKT DATE,
	CONSTRAINT PK_CONGVIEC
	PRIMARY KEY(MADT, SOTT),
)

GO
CREATE TABLE DETAI(
	 MADT CHAR(3),
	 TENDT NVARCHAR(50),
	 CAPQL NVARCHAR(50),
	 KINHPHI FLOAT,
	 NGAYBD DATE,
	 NGAYCT DATE,
	 MACD CHAR(3),
	 GVCNDT CHAR (5),
	 CONSTRAINT PK_DETAI
	 PRIMARY KEY(MADT),
)

GO
CREATE TABLE CHUDE(
	MACD CHAR(3),
	TENCD NVARCHAR(50)
	CONSTRAINT PK_CHUDE
	PRIMARY KEY(MACD)
)

GO
CREATE TABLE NGUOITHAN(
	MAGV CHAR (3),
	TEN VARCHAR(10),
	NGSINH DATE,
	PHAI VARCHAR(20),
	CONSTRAINT PK_NGUOITHAN
	PRIMARY KEY(MAGV, TEN),
)

GO
CREATE TABLE GV_DT(
	MAGV CHAR(3),
	DIENTHOAI CHAR(11),
	CONSTRAINT PK_GVDT
	PRIMARY KEY(MAGV, DIENTHOAI),
)

--TAO KHOA NGOAI
ALTER TABLE GV_DT
ADD CONSTRAINT FK_GVDT_GIAOVIEN
FOREIGN KEY(MAGV)
REFERENCES GIAOVIEN(MAGV)

ALTER TABLE NGUOITHAN
ADD CONSTRAINT FK_NGUOITHAN_GV
FOREIGN KEY(MAGV)
REFERENCES GIAOVIEN(MAGV)

ALTER TABLE DETAI
ADD CONSTRAINT FK_DETAI_CHUDE
FOREIGN KEY(MACD)
REFERENCES CHUDE(MACD)

ALTER TABLE DETAI
ADD CONSTRAINT FK_DETAI_GIAOVIEN
FOREIGN KEY(GVCNDT)
REFERENCES GIAOVIEN(MAGV)

ALTER TABLE CONGVIEC
ADD CONSTRAINT FK_CONGVIEC_DETAI
FOREIGN KEY(MADT)
REFERENCES DETAI(MADT)

ALTER TABLE THAMGIADT
ADD CONSTRAINT FK_THAMGIADT_CONGVIEC
FOREIGN KEY(MADT, STT)
REFERENCES CONGVIEC(MADT, SOTT)

ALTER TABLE THAMGIADT
ADD CONSTRAINT FK_THAMGIADT_GIAOVIEN
FOREIGN KEY(MAGV)
REFERENCES GIAOVIEN(MAGV)

ALTER TABLE KHOA
ADD CONSTRAINT FK_KHOA_GIAOVIEN
FOREIGN KEY(TRUONGKHOA)
REFERENCES GIAOVIEN(MAGV)

ALTER TABLE BOMON
ADD CONSTRAINT FK_BOMON_KHOA
FOREIGN KEY(MAKHOA)
REFERENCES KHOA(MAKHOA)

ALTER TABLE BOMON
ADD CONSTRAINT FK_BOMON_GIAOVIEN
FOREIGN KEY(TRUONGBM)
REFERENCES GIAOVIEN(MAGV)

ALTER TABLE GIAOVIEN
ADD CONSTRAINT FK_GIAOVIEN_BOMON
FOREIGN KEY(MABM)
REFERENCES BOMON(MABM)

ALTER TABLE GIAOVIEN
ADD CONSTRAINT FK_GIAOVIEN_GIAOVIEN
FOREIGN KEY(GVQLCM)
REFERENCES GIAOVIEN(MAGV)

ALTER TABLE BOMON
ADD CONSTRAINT DF_NGAYNHANCHUC
DEFAULT(GETDATE()) FOR NGAYNHANCHUC

--TAO RANG BUOC MIEN GIA TRI
ALTER TABLE GIAOVIEN
ADD CONSTRAINT C_PHAI_GV
CHECK (PHAI IN ('Nam', N'Nữ'))

ALTER TABLE NGUOITHAN
ADD CONSTRAINT C_PHAI_NT
CHECK (PHAI IN ('Nam', N'Nữ'))

--NHAP DU LIEU
GO
INSERT INTO CHUDE (MACD, TENCD)
VALUES('NCP', N'Nghiên cứu phát triển');
INSERT INTO CHUDE (MACD, TENCD)
VALUES('QLG', N'Quản lý giáo dục');
INSERT INTO CHUDE (MACD, TENCD)
VALUES(N'ƯDC', N'Ứng dụng công nghệ');

GO
INSERT INTO GIAOVIEN(MAGV, HOTEN, LUONG, PHAI, NGAYSINH, DIACHI, GVQLCM, MABM)
VALUES('001', N'Nguyễn Hoài Ân', 2000, 'Nam', '1973/02/15', N'25/3 Lạc Long Quân, Q.10, HCM', NULL, null)
INSERT INTO GIAOVIEN(MAGV, HOTEN, LUONG, PHAI, NGAYSINH, DIACHI, GVQLCM, MABM)
VALUES('002', N'Trần Trà Hương', 2500, N'Nữ', '1960/06/20', N'25/3 Trần Hưng Đạo, Q.10, HCM', NULL, null)
INSERT INTO GIAOVIEN(MAGV, HOTEN, LUONG, PHAI, NGAYSINH, DIACHI, GVQLCM, MABM)
VALUES('003', N'Nguyễn Ngọc Ánh', 2200, N'Nữ', '1975/05/11', N'25/3 Võ Văn Ngân Thủ Đức, Q.10, HCM', NULL, null)
INSERT INTO GIAOVIEN(MAGV, HOTEN, LUONG, PHAI, NGAYSINH, DIACHI, GVQLCM, MABM)
VALUES('004', N'Trương Nam Sơn', 2300, 'Nam', '1939/01/11', N'25/3 Long Quân, Q.10, HCM', NULL, null)
INSERT INTO GIAOVIEN(MAGV, HOTEN, LUONG, PHAI, NGAYSINH, DIACHI, GVQLCM, MABM)
VALUES('005', N'Lý Hoàng Hà', 2100, 'Nam', '1993/05/25', N'25/3 Nhổn, Q.10, HCM', NULL, null)

GO
INSERT INTO GV_DT(MAGV, DIENTHOAI)
VALUES('001', '0465434564')
INSERT INTO GV_DT(MAGV, DIENTHOAI)
VALUES('002', '0542544545')
INSERT INTO GV_DT(MAGV, DIENTHOAI)
VALUES('003', '0758754542')
INSERT INTO GV_DT(MAGV, DIENTHOAI)
VALUES('004', '0854212457')
INSERT INTO GV_DT(MAGV, DIENTHOAI)
VALUES('005', '0345457588')

GO
INSERT INTO NGUOITHAN(MAGV, TEN, NGSINH, PHAI)
VALUES('001', 'MAI', '1988/05/03', 'Nam')
INSERT INTO NGUOITHAN(MAGV, TEN, NGSINH, PHAI)
VALUES('002', 'An', '1980/06/20', 'Nam')
INSERT INTO NGUOITHAN(MAGV, TEN, NGSINH, PHAI)
VALUES('003', 'Nam', '1984/07/21', 'Nam')
INSERT INTO NGUOITHAN(MAGV, TEN, NGSINH, PHAI)
VALUES('004', 'Minh', '1928/05/23', 'Nam')
INSERT INTO NGUOITHAN(MAGV, TEN, NGSINH, PHAI)
VALUES('005', 'Thiện', '1998/01/22', 'Nam')

GO
INSERT INTO KHOA(MAKHOA, TENKHOA, NAMTL, PHONG, DIENTHOAI, TRUONGKHOA, NGAYNHANCHUC)
VALUES('IT', N'Công nghệ thông tin', '1995', 'A10', '095645645', '002', '1998/05/12')
INSERT INTO KHOA(MAKHOA, TENKHOA, NAMTL, PHONG, DIENTHOAI, TRUONGKHOA, NGAYNHANCHUC)
VALUES('CS', N'Khoa học máy tính', '1555', 'C10', '054654651', '004', '1998/12/12')
INSERT INTO KHOA(MAKHOA, TENKHOA, NAMTL, PHONG, DIENTHOAI, TRUONGKHOA, NGAYNHANCHUC)
VALUES('PM', N'Kĩ thuật phần mềm', '1995', 'A10', '095645645', '007', '1992/07/11')
INSERT INTO KHOA(MAKHOA, TENKHOA, NAMTL, PHONG, DIENTHOAI, TRUONGKHOA, NGAYNHANCHUC)
VALUES('QT', N'Quản trị mạng', '1993', 'E10', '095645645', '003', '1998/11/30')
INSERT INTO KHOA(MAKHOA, TENKHOA, NAMTL, PHONG, DIENTHOAI, TRUONGKHOA, NGAYNHANCHUC)
VALUES('HT', N'Hệ thống thông tin', '1994', 'D10', '095645645', '001', '1994/07/22')

GO
INSERT INTO BOMON(MABM, TENBM, PHONG, DIENTHOAI, TRUONGBM, MAKHOA, NGAYNHANCHUC)
VALUES('CT', N'CÂU TRÚC DỮ LIỆU', 'A10', '032156456', NULL, NULL, '2006/12/01')
INSERT INTO BOMON(MABM, TENBM, PHONG, DIENTHOAI, TRUONGBM, MAKHOA, NGAYNHANCHUC)
VALUES('TT', N'TRÍ TUỆ NHÂN TẠO', 'A10', '032156456', NULL, NULL, NULL)
INSERT INTO BOMON(MABM, TENBM, PHONG, DIENTHOAI, TRUONGBM, MAKHOA, NGAYNHANCHUC)
VALUES('CB', N'THIẾT KẾ WEB', 'B10', '045687678', NULL, NULL, '2016/01/02')
INSERT INTO BOMON(MABM, TENBM, PHONG, DIENTHOAI, TRUONGBM, MAKHOA, NGAYNHANCHUC)
VALUES('DA', N'QUẢN TRỊ MẠNG', 'C10', '054546540', NULL, NULL, NULL)
INSERT INTO BOMON(MABM, TENBM, PHONG, DIENTHOAI, TRUONGBM, MAKHOA, NGAYNHANCHUC)
VALUES('Â', N'CÔNG NGHỆ XML', 'D10', '067886786', NULL, NULL, '2011/06/04')

GO
INSERT INTO DETAI(MADT, TENDT, CAPQL, KINHPHI, NGAYBD, NGAYCT, MACD, GVCNDT)
VALUES('001', 'HH1', 'CAPQL 1', '9.1', '1998/01/22', '2000/05/23', NULL, NULL)
INSERT INTO DETAI(MADT, TENDT, CAPQL, KINHPHI, NGAYBD, NGAYCT, MACD, GVCNDT)
VALUES('002', 'GG2', 'CAPQL 2', '7.1', '2000/05/30', '2001/01/22', NULL, NULL)
INSERT INTO DETAI(MADT, TENDT, CAPQL, KINHPHI, NGAYBD, NGAYCT, MACD, GVCNDT)
VALUES('003', 'GG3', 'CAPQL 3', '5.1', '1991/11/12', '1994/07/12', NULL, NULL)
INSERT INTO DETAI(MADT, TENDT, CAPQL, KINHPHI, NGAYBD, NGAYCT, MACD, GVCNDT)
VALUES('004', 'FFI4', 'CAPQL 4', '8.1', '1990/12/23', '1999/11/03', NULL, NULL)
INSERT INTO DETAI(MADT, TENDT, CAPQL, KINHPHI, NGAYBD, NGAYCT, MACD, GVCNDT)
VALUES('005', 'RRI5', 'CAPQL 5', '1.1', '1994/03/02', '1995/12/11', NULL, NULL)

-- UPDATE
GO
UPDATE GIAOVIEN
SET MABM = 'CT'
WHERE (MAGV = '001') OR (MAGV = '009') 

-- SELECT
SELECT HOTEN, LUONG
FROM GIAOVIEN
ORDER BY LUONG, HOTEN

SELECT *
FROM GIAOVIEN
WHERE PHAI LIKE '%m'

SELECT *
FROM GIAOVIEN
WHERE YEAR(NGAYSINH) NOT BETWEEN 1930 AND 1973

SELECT *
FROM GIAOVIEN
WHERE GVQLCM IS NULL

SELECT * FROM DETAI
WHERE DATEDIFF(d, NGAYBD, '1997/01/23') > 0 -- NGAYBD - 1997/01/23 (NGAYBD - 03)

SELECT HOTEN + CAST(LUONG AS VARCHAR) -- CAST = CONVERT
FROM GIAOVIEN

SELECT *
FROM GIAOVIEN
WHERE PHAI = 'Nam'
UNION -- HOP.
--INTERSECT GIAO
SELECT *
FROM GIAOVIEN
WHERE PHAI = N'Nữ'


SELECT *
FROM GIAOVIEN
EXCEPT -- TRU`
SELECT *
FROM GIAOVIEN
WHERE PHAI = 'Nam'

-- JOIN
-- INNER JOIN
SELECT HOTEN, TENBM
FROM GIAOVIEN AS GV JOIN BOMON AS BM ON GV.MABM = BM.MABM

SELECT DT.MADT, CD.TENCD
FROM DETAI DT JOIN CHUDE CD ON DT.MACD = CD.MACD

SELECT DT.MADT, CD.TENCD, GV.HOTEN, GV.NGAYSINH, GV.DIACHI
FROM DETAI DT JOIN CHUDE CD ON DT.MACD = CD.MACD
	JOIN GIAOVIEN GV ON GV.MAGV = DT.GVCNDT

SELECT GV.MAGV, GV.HOTEN, GV2.HOTEN AS GVQL
FROM GIAOVIEN GV JOIN GIAOVIEN GV2 ON GV.GVQLCM = GV2.MAGV

-- LEFT JOIN
SELECT GV.MAGV, GV.HOTEN, GV2.HOTEN AS GVQL
FROM GIAOVIEN GV LEFT JOIN GIAOVIEN GV2 ON GV.GVQLCM = GV2.MAGV

-- RIGHT JOIN
SELECT GV.MAGV, GV.HOTEN, GV2.HOTEN AS GVQL
FROM GIAOVIEN GV RIGHT JOIN GIAOVIEN GV2 ON GV.GVQLCM = GV2.MAGV

-- COUNT
SELECT COUNT(*) AS SOLUONGGV
FROM GIAOVIEN

SELECT COUNT(GV.HOTEN)
FROM GIAOVIEN GV
WHERE GV.GVQLCM IS NOT NULL

SELECT GV.MAGV
FROM GIAOVIEN GV
WHERE GV.GVQLCM IN (
	SELECT GV2.GVQLCM
	FROM GIAOVIEN GV2
)

SELECT COUNT(DISTINCT(GV.GVQLCM)) -- DISTINCT GET VALUE NOT EQUALS
FROM GIAOVIEN GV

SELECT ROUND(AVG(GV.LUONG),2) AS LUONGTB -- ####.## 
FROM GIAOVIEN GV

SELECT BM.MABM, COUNT(GV.MAGV) AS SOLUONGGV
FROM BOMON BM LEFT JOIN GIAOVIEN GV ON GV.MABM = BM.MABM
GROUP BY BM.MABM -- GOP 2 CAI TRUNG` THANH` 1

SELECT BM.TENBM, (
	SELECT COUNT(GV.MAGV)
	FROM GIAOVIEN GV
	WHERE GV.MABM = BM.MABM
)
FROM BOMON BM

SELECT * 
FROM ( 
	SELECT GV.HOTEN, GV.LUONG
	FROM GIAOVIEN GV
	WHERE GV.MABM = 'DA'
) AS KQ

SELECT GV.MAGV, GV.HOTEN, GV.LUONG
FROM GIAOVIEN GV
WHERE GV.LUONG > (
	SELECT GV2.LUONG
	FROM GIAOVIEN GV2
	WHERE GV2.MAGV = '003'
)

SELECT TOP 1 GV.MAGV, GV.HOTEN, GV.LUONG
FROM GIAOVIEN GV
WHERE GV.LUONG >= ALL (
	SELECT GV2.LUONG
	FROM GIAOVIEN GV2
)

SELECT GV.MAGV, GV.HOTEN
FROM GIAOVIEN GV
WHERE GV.MAGV = ANY (
	SELECT DT.GVCNDT
	FROM DETAI DT
)

SELECT GV.MAGV, GV.HOTEN 
FROM GIAOVIEN GV
WHERE EXISTS (
	SELECT DT.GVCNDT
	FROM DETAI DT
	WHERE DT.GVCNDT = GV.MAGV
)
